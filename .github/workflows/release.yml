name: Release

on:
  push:
    branches: [main]

# ‰ªÖËµã‰∫àÂøÖË¶ÅÁöÑÊùÉÈôêÔºåÈÅµÂæ™ÊúÄÂ∞èÊùÉÈôêÂéüÂàô
permissions:
  contents: read

jobs:
  check-release:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.parse.outputs.should_release }}
      version: ${{ steps.parse.outputs.version }}
      tag_name: ${{ steps.parse.outputs.tag_name }}
      is_prerelease: ${{ steps.parse.outputs.is_prerelease }}
      changelog: ${{ steps.parse.outputs.changelog }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse release commit
        id: parse
        shell: bash
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit: $COMMIT_MSG"

          # Ê≠£ÂàôÂåπÈÖç release: vX.Y.Z-suffix Ê†ºÂºè
          REGEX="^release:[[:space:]]*(v?)([0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9._]+)*)"

          if [[ "$COMMIT_MSG" =~ $REGEX ]]; then
            VERSION="${BASH_REMATCH[2]}"
            PREFIX="${BASH_REMATCH[1]}"
            
            # Áªü‰∏ÄÂ§ÑÁêÜ v ÂâçÁºÄ
            [[ "$PREFIX" == "v" ]] && TAG_NAME="v$VERSION" || TAG_NAME="v$VERSION"
            
            # Ê£ÄÊµãÊòØÂê¶‰∏∫È¢ÑÂèëÂ∏ÉÁâàÊú¨
            [[ "$VERSION" =~ -(alpha|beta|rc|dev|preview) ]] && IS_PRERELEASE="true" || IS_PRERELEASE="false"
            
            # ÁîüÊàê Changelog
            # ‰ªé HEAD^ Êü•ÊâæÊúÄËøëÁöÑ tagÔºåËé∑ÂèñÂèòÊõ¥ËÆ∞ÂΩï
            LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

            if [ -z "$LAST_TAG" ]; then
              echo "üìù No previous tag found, getting full history"
              CHANGELOG=$(git log --pretty=format:"- %s (%h)" | grep -v "^- release:" || true)
            else
              echo "üìù Generating changelog from $LAST_TAG to HEAD"
              CHANGELOG=$(git log "${LAST_TAG}..HEAD" --pretty=format:"- %s (%h)" | grep -v "^- release:" || true)
            fi
            
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
            echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
            
            echo "changelog<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGELOG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "‚úÖ Release detected: $TAG_NAME (pre-release: $IS_PRERELEASE)"
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Skipping: Not a release commit"
          fi

  create-release:
    needs: check-release
    if: needs.check-release.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ needs.check-release.outputs.tag_name }}
          NOTES: ${{ needs.check-release.outputs.changelog }}
          IS_PRERELEASE: ${{ needs.check-release.outputs.is_prerelease }}
        run: |
          # Â∞ùËØïÂàõÂª∫ ReleaseÔºåÂ¶ÇÊûúÂ∑≤Â≠òÂú®ÂàôÂøΩÁï•ÈîôËØØÔºàÊîØÊåÅÈáçËØïÔºâ
          gh release create "$TAG_NAME" \
            --title "$TAG_NAME" \
            --notes "$NOTES" \
            --prerelease="$IS_PRERELEASE" \
            --target main || echo "‚ö†Ô∏è Release $TAG_NAME might already exist"

  release:
    needs: [check-release, create-release]
    if: needs.check-release.outputs.should_release == 'true'
    permissions:
      contents: write
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'pnpm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install project dependencies
        run: pnpm install --frozen-lockfile

      - name: Configure Tauri (Standard)
        shell: pwsh
        run: |
          echo "‚öôÔ∏è Using Standard Config (tauri.windows.conf.json)..."
          # ÈªòËÆ§‰ªìÂ∫ì‰∏≠Â∑≤ÂåÖÂê´ tauri.windows.conf.json (ËÆæÁΩÆ‰∏∫ DownloadBootstrapper)

      - name: Build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: pnpm tauri build

      - name: Upload Release Assets
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.check-release.outputs.tag_name }}
          VERSION: ${{ needs.check-release.outputs.version }}
        run: |
          $NSIS_DIR = "src-tauri/target/release/bundle/nsis"

          # Ëé∑ÂèñÊâÄÊúâÁõ∏ÂÖ≥Êñá‰ª∂ (.exe, .nsis.zip, .sig)
          $SetupFiles = Get-ChildItem "$NSIS_DIR/*" -Include "*-setup.exe", "*-setup.nsis.zip", "*-setup.nsis.zip.sig"

          if ($SetupFiles.Count -gt 0) {
             foreach ($File in $SetupFiles) {
                echo "‚¨ÜÔ∏è Uploading $($File.Name)..."
                gh release upload $env:TAG $File.FullName --clobber
             }
          } else {
             Write-Error "‚ùå Setup files not found in $NSIS_DIR"
             exit 1
          }

      - name: Upload Portable Zip
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.check-release.outputs.tag_name }}
          VERSION: ${{ needs.check-release.outputs.version }}
        run: |
          $EXE_PATH = "src-tauri/target/release/fon.exe"
          $ZIP_NAME = "fon_$($env:VERSION)_x64.zip"

          if (Test-Path $EXE_PATH) {
            echo "üì¶ Compressing to $ZIP_NAME..."
            Compress-Archive -Path $EXE_PATH -DestinationPath $ZIP_NAME
            
            echo "‚¨ÜÔ∏è Uploading Zip..."
            gh release upload $env:TAG $ZIP_NAME --clobber
          }

  release-for-fixed-webview2:
    needs: [check-release, create-release]
    if: needs.check-release.outputs.should_release == 'true'
    permissions:
      contents: write
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: 'pnpm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install project dependencies
        run: pnpm install --frozen-lockfile

      - name: Download WebView2 Runtime
        shell: pwsh
        run: |
          $WbvVer = "109.0.1518.78"
          $Arch = "x64"
          $FileName = "Microsoft.WebView2.FixedVersionRuntime.$WbvVer.$Arch.cab"
          $Url = "https://github.com/westinyang/WebView2RuntimeArchive/releases/download/$WbvVer/$FileName"
          $Dest = "$FileName"

          echo "‚¨áÔ∏è Downloading WebView2 Fixed Runtime ($WbvVer)..."
          Invoke-WebRequest -Uri $Url -OutFile $Dest

          echo "üì¶ Extracting to ./src-tauri/Microsoft.WebView2.FixedVersionRuntime.$WbvVer.$Arch/ ..."
          $ExtractPath = "./src-tauri/Microsoft.WebView2.FixedVersionRuntime.$WbvVer.$Arch"
          New-Item -ItemType Directory -Force -Path $ExtractPath | Out-Null

          # ‰ΩøÁî® expand.exe (-F:* ÊèêÂèñÊâÄÊúâÊñá‰ª∂)
          expand $Dest -F:* $ExtractPath

      - name: Configure Tauri (Switch to Fixed WebView2)
        shell: pwsh
        run: |
          echo "‚öôÔ∏è Switching to Offline Config (webview2.x64.json)..."
          Remove-Item "src-tauri/tauri.windows.conf.json" -ErrorAction SilentlyContinue
          Copy-Item "src-tauri/webview2.x64.json" "src-tauri/tauri.windows.conf.json"

      - name: Build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: pnpm tauri build

      - name: Rename and Upload Assets
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.check-release.outputs.tag_name }}
          SUFFIX: '-fixed-webview2'
        run: |
          $NSIS_DIR = "src-tauri/target/release/bundle/nsis"
          # ‰ªÖ‰∏ä‰º† setup Áõ∏ÂÖ≥Êñá‰ª∂
          $SetupFiles = Get-ChildItem "$NSIS_DIR/*" -Include "*-setup.exe", "*-setup.nsis.zip", "*-setup.nsis.zip.sig"

          if ($SetupFiles.Count -gt 0) {
             foreach ($File in $SetupFiles) {
                # ÁÆÄÂçïÁöÑÊõøÊç¢ÈÄªËæëÔºöÊää "-setup" ÊõøÊç¢‰∏∫ "_fixed_webview2-setup" (Clash È£éÊ†º)
                # ‰æãÂ¶Ç: fon_0.0.6_x64-setup.exe -> fon_0.0.6_x64_fixed_webview2-setup.exe
                $NewName = $File.Name.Replace("-setup", "_fixed_webview2-setup")
                $NewPath = Join-Path $NSIS_DIR $NewName
                
                Rename-Item -Path $File.FullName -NewName $NewName
                
                echo "‚¨ÜÔ∏è Uploading $NewName..."
                gh release upload $env:TAG $NewPath --clobber
             }
          } else {
             Write-Error "‚ùå Setup files not found"
             exit 1
          }
